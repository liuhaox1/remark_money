# 多人账本 & 统计按成员（饼图）需求文档

## 1. 背景与目标

### 目标
- 支持多人账本（共享账单）。
- 多人账本“分类”采用共享口径：所有成员展示/统计/导出一致。
- 仅创建者（Owner）可修改共享分类，其他成员只读。
- 统计页新增“按成员维度”的饼图展示收入/支出贡献。
- 账本下的成员列表可查看，并提供合理入口。

### 非目标（本期不做）
- AA 分摊、代付、多人拆分一笔账。
- 多币种折算统计。
- 成员角色体系的复杂权限（仅区分 Owner vs 非 Owner）。

## 2. 术语
- 账本（Book）：记录共享范围的容器，包含成员与数据。
- 多人账本：`is_multi = true` 的账本。
- Owner：账本创建者（`owner_id`）。
- 成员（Member）：加入账本的用户。
- 共享分类：按账本维度维护的一套分类（所有成员一致）。
- 记账人：创建该条账单的用户（用于成员统计的最小闭环口径）。

## 3. 业务口径（必须统一，否则必出 BUG）

### 3.1 分类口径
- 多人账本：分类为“账本级共享分类”，与个人分类隔离。
- 单人账本：分类维持原有口径（个人分类）。
- 账单引用分类：多人账本账单的 `category_key` 必须来自共享分类集合，确保所有成员可解析。

### 3.2 谁能修改分类
- 仅 Owner 可新增/编辑/删除共享分类。
- 非 Owner：
  - 分类选择器可用（用于记账/筛选/统计）。
  - 分类管理入口展示只读态（隐藏写操作，提示“仅创建者可修改”）。

### 3.3 共享分类从哪来（初始化策略）
- 创建多人账本时，使用“系统默认分类模板”初始化一份共享分类。
  - 客户端默认模板来源：`CategoryRepository.defaultCategories`（`lib/repository/category_repository.dart`）。
- 不默认从创建者个人分类拷贝（避免“创建即大改”的常态与数据污染）。
- 可选（后续扩展）：创建多人账本时提供“从我的分类复制”高级选项（默认关闭/次级入口）。

## 4. 功能需求

### 4.1 多人账本创建/加入
- 创建多人账本：
  - 创建成功返回 `bookId`、`inviteCode`。
  - 初始化共享分类（系统模板）并持久化到服务端（账本维度）。
- 加入多人账本：
  - B 通过邀请码加入，服务端校验有效性并建立成员关系。
  - 客户端切换到该 `bookId` 后，优先拉取一次共享分类（避免“未知分类”）。

### 4.2 成员列表入口与展示
#### 入口（推荐双入口）
- 入口 1：账本切换器/账本管理/账本详情页 -> “成员列表/成员管理”。
- 入口 2：首页/统计页顶部“当前账本”区域（点击进入账本详情，再进入成员列表）。

#### 成员列表展示字段
- 昵称/用户名（优先昵称）
- 角色：Owner/成员
- 加入时间（可选）
- 状态：正常/已退出（保留历史账单归属展示）

#### 权限
- 所有成员可查看成员列表。
- 本期仅定义 Owner 写权限用于“分类管理”，不强制要求踢人/转让等管理动作（可后续加）。

### 4.3 统计页：按成员饼图（最小闭环）
#### 统计口径
- 维度：按“记账人”统计。
- 统计项：支出饼图、收入饼图（两个 tab 或一个切换）。
- 范围：严格复用现有统计页的筛选条件（时间范围、账本、是否计入统计、排除删除等），避免“列表与统计对不上”。

#### 展示与交互
- 饼图：按金额占比展示成员贡献。
- 列表：饼图下展示成员排行（金额/占比）。
- TopN：默认 Top6 + “其他”聚合（防止成员多时渲染/可读性问题）。
- 点击扇区/列表项：进入该成员的账单明细（复用现有列表页筛选能力），并可一键返回“全部成员”。

## 5. 同步与一致性（关键：避免导出/展示 BUG）

### 5.1 成员如何拿到最新共享分类
- 基线方案（最简单，保证最终一致）：在 `app_start/app_resumed/periodic` 的 meta sync 中拉取共享分类。
- 优化方案（推荐，减少不必要 SQL）：
  - 服务端维护 `categoryVersion`（账本级版本号，或共享分类最大 `sync_version`）。
  - 在账单增量拉取（v2 pull）/summary 响应中返回 `categoryVersion`。
  - 客户端本地保存 `localCategoryVersion[bookId]`，发现 `server > local` 时触发一次 `downloadCategories(bookId)`。

### 5.2 兜底策略（极其重要）
- 若客户端渲染账单时发现 `category_key` 本地无法解析：
  - UI 显示“未知分类”（避免崩溃/错归类）。
  - 立刻触发一次该 `bookId` 的共享分类拉取，并在拉取完成后刷新显示。

## 6. 边界/极限操作/异常场景（必须覆盖）

### 6.1 权限与安全
- 非 Owner 尝试新增/编辑/删除分类（抓包/接口直调）：
  - 服务端必须拦截并返回权限错误；客户端展示友好提示。
- 邀请码：
  - 过期/无效/账本不可用：提示明确原因，不可进入。
  - 输入大小写/空格/长度不对：本地校验，避免无效请求。

### 6.2 多端并发与一致性
- Owner 在 A 端修改分类，B 端同时在统计页/记一笔：
  - B 端不应崩溃；若分类版本变化，下一次同步后可见。
- 成员加入/退出：
  - 退出成员的历史账单仍需可展示其贡献（成员列表显示“已退出成员”占位）。

### 6.3 离线与弱网
- 离线加入/离线切换账本：
  - 若本地没有该账本共享分类，允许进入但提示“数据未同步”，并降级显示“未知分类”直到同步成功。
- 同步失败重试：
  - 避免无限重试导致频繁 SQL/电量消耗；采用退避/限频。

### 6.4 数据规模与极限操作
- 账单量大（例如 5w 条）：
  - 统计聚合必须分页/增量或使用缓存，避免每次打开统计页全量遍历。
- 成员数多（例如 50 人）：
  - 饼图 TopN + 其他聚合；列表虚拟化/限制重建。
- 高频操作：
  - 快速切换账本、反复进入统计页、连续新增账单：不应触发重复同步风暴。

## 7. 性能要求（可验收的指标）

### 7.1 客户端
- 打开统计页：应优先复用已有内存/缓存数据，避免阻塞 UI；必要时异步计算并展示 loading skeleton。
- 同步触发：同一 `bookId` 在短时间内的 meta/sync 请求需要合并（singleflight + debounce），避免重复请求/重复写入本地。

### 7.2 服务端
- 共享分类接口：
  - 优先按 `bookId` 进行索引查询，避免扫描用户全量分类。
- 统计相关（若后续迁移到服务端聚合）：
  - 支持按 `bookId + timeRange` 聚合缓存/预聚合，避免实时全表扫。

## 8. 验收标准（摘要）
- 多人账本中，Owner 新增/修改分类后，成员端在合理时间内可获得并正确展示/导出。
- 非 Owner 无法修改分类（UI 不提供入口 + 服务端强制拦截）。
- 统计页新增“按成员饼图”，金额/占比与明细筛选一致，且性能可接受（不卡顿、不频繁重复同步）。
- 成员列表入口可发现，信息完整，边界/异常不崩溃、有提示。

