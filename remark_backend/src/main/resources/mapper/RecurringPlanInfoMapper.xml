<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.remark.money.mapper.RecurringPlanInfoMapper">

  <resultMap id="RecurringPlanInfoResultMap" type="com.remark.money.entity.RecurringPlanInfo">
    <id property="id" column="id"/>
    <result property="userId" column="user_id"/>
    <result property="bookId" column="book_id"/>
    <result property="planId" column="plan_id"/>
    <result property="payloadJson" column="payload_json"/>
    <result property="isDelete" column="is_delete"/>
    <result property="syncVersion" column="sync_version"/>
    <result property="updateTime" column="update_time"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <select id="findByUserIdBookIdAndPlanId" resultMap="RecurringPlanInfoResultMap">
    SELECT *
    FROM recurring_plan_info
    WHERE user_id = #{userId}
      AND book_id = #{bookId}
      AND plan_id = #{planId}
    LIMIT 1
  </select>

  <select id="findByUserIdBookIdAndPlanIds" resultMap="RecurringPlanInfoResultMap">
    SELECT *
    FROM recurring_plan_info
    WHERE user_id = #{userId}
      AND book_id = #{bookId}
      AND plan_id IN
      <foreach collection="planIds" item="planId" open="(" separator="," close=")">
        #{planId}
      </foreach>
  </select>

  <select id="findAllByUserIdAndBookId" resultMap="RecurringPlanInfoResultMap">
    SELECT *
    FROM recurring_plan_info
    WHERE user_id = #{userId}
      AND book_id = #{bookId}
  </select>

  <select id="findAllActive" resultMap="RecurringPlanInfoResultMap">
    SELECT *
    FROM recurring_plan_info
    WHERE is_delete = 0
  </select>

  <insert id="insertOne" parameterType="com.remark.money.entity.RecurringPlanInfo" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO recurring_plan_info (
      user_id,
      book_id,
      plan_id,
      payload_json,
      is_delete,
      sync_version,
      update_time,
      created_at
    )
    VALUES (
      #{plan.userId},
      #{plan.bookId},
      #{plan.planId},
      #{plan.payloadJson},
      #{plan.isDelete},
      1,
      NOW(),
      NOW()
    )
  </insert>

  <update id="updateWithExpectedSyncVersion">
    UPDATE recurring_plan_info
    SET
      payload_json = #{plan.payloadJson},
      is_delete = #{plan.isDelete},
      sync_version = sync_version + 1,
      update_time = NOW()
    WHERE user_id = #{plan.userId}
      AND book_id = #{plan.bookId}
      AND plan_id = #{plan.planId}
      AND sync_version = #{expectedSyncVersion}
  </update>

  <update id="softDeleteByPlanId">
    UPDATE recurring_plan_info
    SET is_delete = 1, sync_version = sync_version + 1, update_time = NOW()
    WHERE user_id = #{userId}
      AND book_id = #{bookId}
      AND plan_id = #{planId}
  </update>

  <update id="updatePayloadAndBumpVersion">
    UPDATE recurring_plan_info
    SET payload_json = #{payloadJson}, sync_version = sync_version + 1, update_time = NOW()
    WHERE user_id = #{userId}
      AND book_id = #{bookId}
      AND plan_id = #{planId}
      AND is_delete = 0
  </update>

</mapper>
