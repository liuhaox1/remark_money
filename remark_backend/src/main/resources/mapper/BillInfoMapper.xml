<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.remark.money.mapper.BillInfoMapper">

  <resultMap id="BillInfoResultMap" type="com.remark.money.entity.BillInfo">
    <id property="id" column="id"/>
    <result property="userId" column="user_id"/>
    <result property="bookId" column="book_id"/>
    <result property="accountId" column="account_id"/>
    <result property="categoryKey" column="category_key"/>
    <result property="amount" column="amount"/>
    <result property="direction" column="direction"/>
    <result property="remark" column="remark"/>
    <result property="attachmentUrl" column="attachment_url"/>
    <result property="billDate" column="bill_date"/>
    <result property="includeInStats" column="include_in_stats"/>
    <result property="pairId" column="pair_id"/>
    <result property="tagIds" column="tag_ids"/>
    <result property="isDelete" column="is_delete"/>
    <result property="version" column="version"/>
    <result property="updateTime" column="update_time"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <select id="findById" resultMap="BillInfoResultMap">
    SELECT * FROM bill_info WHERE id = #{id}
  </select>

  <select id="findByIdForUserAndBook" resultMap="BillInfoResultMap">
    SELECT * FROM bill_info WHERE id = #{id} AND user_id = #{userId} AND book_id = #{bookId}
  </select>

  <select id="findByIdForBook" resultMap="BillInfoResultMap">
    SELECT * FROM bill_info WHERE id = #{id} AND book_id = #{bookId}
  </select>

  <select id="findByIds" resultMap="BillInfoResultMap">
    SELECT * FROM bill_info WHERE id IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select>

  <select id="findByIdsForUserAndBook" resultMap="BillInfoResultMap">
    SELECT * FROM bill_info WHERE user_id = #{userId} AND book_id = #{bookId} AND id IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select>

  <select id="findByIdsForBook" resultMap="BillInfoResultMap">
    SELECT * FROM bill_info WHERE book_id = #{bookId} AND id IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select>

  <insert id="insert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO bill_info (user_id, book_id, account_id, category_key, amount, direction,
                          remark, attachment_url, bill_date, include_in_stats, pair_id, tag_ids, is_delete, update_time, created_at)
    VALUES (#{userId}, #{bookId}, #{accountId}, #{categoryKey}, #{amount}, #{direction},
            #{remark}, #{attachmentUrl}, #{billDate}, #{includeInStats}, #{pairId}, #{tagIds}, #{isDelete}, NOW(), NOW())
  </insert>

  <insert id="batchInsert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO bill_info (user_id, book_id, account_id, category_key, amount, direction,
                          remark, attachment_url, bill_date, include_in_stats, pair_id, tag_ids, is_delete, update_time, created_at)
    VALUES
    <foreach collection="list" item="item" separator=",">
      (#{item.userId}, #{item.bookId}, #{item.accountId}, #{item.categoryKey}, #{item.amount}, #{item.direction},
       #{item.remark}, #{item.attachmentUrl}, #{item.billDate}, #{item.includeInStats}, #{item.pairId}, #{item.tagIds}, #{item.isDelete}, NOW(), NOW())
    </foreach>
  </insert>

  <!-- v2: batch insert with explicit auto-increment ids (client-allocated) -->
  <insert id="batchInsertWithId">
    INSERT INTO bill_info (id, user_id, book_id, account_id, category_key, amount, direction,
                          remark, attachment_url, bill_date, include_in_stats, pair_id, tag_ids, is_delete, update_time, created_at)
    VALUES
    <foreach collection="list" item="item" separator=",">
      (#{item.id}, #{item.userId}, #{item.bookId}, #{item.accountId}, #{item.categoryKey}, #{item.amount}, #{item.direction},
       #{item.remark}, #{item.attachmentUrl}, #{item.billDate}, #{item.includeInStats}, #{item.pairId}, #{item.tagIds}, #{item.isDelete}, NOW(), NOW())
    </foreach>
  </insert>


  <update id="updateById">
    UPDATE bill_info SET
      account_id = #{accountId},
      category_key = #{categoryKey},
      amount = #{amount},
      direction = #{direction},
      remark = #{remark},
      attachment_url = #{attachmentUrl},
      bill_date = #{billDate},
      include_in_stats = #{includeInStats},
      pair_id = #{pairId},
      tag_ids = #{tagIds},
      is_delete = #{isDelete},
      update_time = NOW()
    WHERE id = #{id} AND user_id = #{userId}
  </update>

  <update id="batchUpdate">
    <foreach collection="list" item="item" separator=";">
      UPDATE bill_info SET
        account_id = #{item.accountId},
        category_key = #{item.categoryKey},
        amount = #{item.amount},
        direction = #{item.direction},
        remark = #{item.remark},
        attachment_url = #{item.attachmentUrl},
        bill_date = #{item.billDate},
        include_in_stats = #{item.includeInStats},
        pair_id = #{item.pairId},
        tag_ids = #{item.tagIds},
        is_delete = #{item.isDelete},
        update_time = NOW()
      WHERE id = #{item.id} AND user_id = #{item.userId}
    </foreach>
  </update>

  <select id="countByUserIdAndBookId" resultType="int">
    SELECT COUNT(*) FROM bill_info
    WHERE user_id = #{userId} AND book_id = #{bookId} AND is_delete = 0 AND include_in_stats = 1
  </select>

  <select id="countByBookId" resultType="int">
    SELECT COUNT(*) FROM bill_info
    WHERE book_id = #{bookId} AND is_delete = 0 AND include_in_stats = 1
  </select>

  <select id="findAllByUserIdAndBookId" resultMap="BillInfoResultMap">
    SELECT * FROM bill_info
    WHERE user_id = #{userId} AND book_id = #{bookId} AND is_delete = 0 AND include_in_stats = 1
    ORDER BY update_time ASC, id ASC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="findAllByBookId" resultMap="BillInfoResultMap">
    SELECT * FROM bill_info
    WHERE book_id = #{bookId} AND is_delete = 0 AND include_in_stats = 1
    ORDER BY update_time ASC, id ASC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="findIncrementalByUserIdAndBookId" resultMap="BillInfoResultMap">
    SELECT * FROM bill_info
    WHERE user_id = #{userId} AND book_id = #{bookId} AND include_in_stats = 1
      AND (update_time > #{lastSyncTime} OR (update_time = #{lastSyncTime} AND id > #{lastSyncId}))
    ORDER BY update_time ASC, id ASC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="findIncrementalByBookId" resultMap="BillInfoResultMap">
    SELECT * FROM bill_info
    WHERE book_id = #{bookId} AND include_in_stats = 1
      AND (update_time > #{lastSyncTime} OR (update_time = #{lastSyncTime} AND id > #{lastSyncId}))
    ORDER BY update_time ASC, id ASC
    LIMIT #{limit} OFFSET #{offset}
  </select>

  <select id="findMaxIdByUserIdAndBookId" resultType="Long">
    SELECT MAX(id) FROM bill_info
    WHERE user_id = #{userId} AND book_id = #{bookId} AND is_delete = 0 AND include_in_stats = 1
  </select>

  <select id="findMaxIdByBookId" resultType="Long">
    SELECT MAX(id) FROM bill_info
    WHERE book_id = #{bookId} AND is_delete = 0 AND include_in_stats = 1
  </select>

  <!-- v2 optimistic-lock update (single-user book) -->
  <update id="updateWithExpectedVersionByUserIdAndBookId">
    UPDATE bill_info SET
      account_id = #{bill.accountId},
      category_key = #{bill.categoryKey},
      amount = #{bill.amount},
      direction = #{bill.direction},
      remark = #{bill.remark},
      attachment_url = #{bill.attachmentUrl},
      bill_date = #{bill.billDate},
      include_in_stats = #{bill.includeInStats},
      pair_id = #{bill.pairId},
      tag_ids = #{bill.tagIds},
      is_delete = #{bill.isDelete},
      version = version + 1,
      update_time = NOW()
    WHERE user_id = #{userId} AND book_id = #{bookId} AND id = #{bill.id} AND version = #{expectedVersion}
  </update>

  <!-- v2 optimistic-lock update (multi-user/shared book) -->
  <update id="updateWithExpectedVersionByBookId">
    UPDATE bill_info SET
      account_id = #{bill.accountId},
      category_key = #{bill.categoryKey},
      amount = #{bill.amount},
      direction = #{bill.direction},
      remark = #{bill.remark},
      attachment_url = #{bill.attachmentUrl},
      bill_date = #{bill.billDate},
      include_in_stats = #{bill.includeInStats},
      pair_id = #{bill.pairId},
      tag_ids = #{bill.tagIds},
      is_delete = #{bill.isDelete},
      version = version + 1,
      update_time = NOW()
    WHERE book_id = #{bookId} AND id = #{bill.id} AND version = #{expectedVersion}
  </update>

  <!-- v2 optimistic-lock soft delete (single-user book) -->
  <update id="softDeleteWithExpectedVersionByUserIdAndBookId">
    UPDATE bill_info SET
      is_delete = 1,
      version = version + 1,
      update_time = NOW()
    WHERE user_id = #{userId} AND book_id = #{bookId} AND id = #{id} AND version = #{expectedVersion}
  </update>

  <!-- v2 optimistic-lock soft delete (multi-user/shared book) -->
  <update id="softDeleteWithExpectedVersionByBookId">
    UPDATE bill_info SET
      is_delete = 1,
      version = version + 1,
      update_time = NOW()
    WHERE book_id = #{bookId} AND id = #{id} AND version = #{expectedVersion}
  </update>

</mapper>
