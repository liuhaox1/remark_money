<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.remark.money.mapper.SyncOpDedupMapper">

  <resultMap id="SyncOpDedupResultMap" type="com.remark.money.entity.SyncOpDedup">
    <id property="id" column="id"/>
    <result property="userId" column="user_id"/>
    <result property="bookId" column="book_id"/>
    <result property="opId" column="op_id"/>
    <result property="requestId" column="request_id"/>
    <result property="deviceId" column="device_id"/>
    <result property="syncReason" column="sync_reason"/>
    <result property="status" column="status"/>
    <result property="billId" column="bill_id"/>
    <result property="billVersion" column="bill_version"/>
    <result property="error" column="error"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <select id="find" resultMap="SyncOpDedupResultMap">
    SELECT id, user_id, book_id, op_id, request_id, device_id, sync_reason, status, bill_id, bill_version, error, created_at
    FROM sync_op_dedup
    WHERE user_id = #{userId} AND book_id = #{bookId} AND op_id = #{opId}
    LIMIT 1
  </select>

  <select id="findByOpIds" resultMap="SyncOpDedupResultMap">
    SELECT id, user_id, book_id, op_id, request_id, device_id, sync_reason, status, bill_id, bill_version, error, created_at
    FROM sync_op_dedup
    WHERE user_id = #{userId} AND book_id = #{bookId}
      AND op_id IN
      <foreach collection="opIds" item="opId" open="(" separator="," close=")">
        #{opId}
      </foreach>
  </select>

  <insert id="insert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO sync_op_dedup (user_id, book_id, op_id, request_id, device_id, sync_reason, status, bill_id, bill_version, error, created_at)
    VALUES (#{userId}, #{bookId}, #{opId}, #{requestId}, #{deviceId}, #{syncReason}, #{status}, #{billId}, #{billVersion}, #{error}, NOW())
  </insert>

  <insert id="batchInsert">
    INSERT INTO sync_op_dedup (user_id, book_id, op_id, request_id, device_id, sync_reason, status, bill_id, bill_version, error, created_at)
    VALUES
    <foreach collection="list" item="item" separator=",">
      (#{item.userId}, #{item.bookId}, #{item.opId}, #{item.requestId}, #{item.deviceId}, #{item.syncReason}, #{item.status}, #{item.billId}, #{item.billVersion}, #{item.error}, NOW())
    </foreach>
  </insert>

  <delete id="deleteBefore">
    DELETE FROM sync_op_dedup WHERE created_at &lt; #{cutoff}
  </delete>

  <select id="findIdsBefore" resultType="long">
    SELECT id
    FROM sync_op_dedup
    WHERE created_at &lt; #{cutoff}
    ORDER BY created_at ASC, id ASC
    LIMIT #{limit}
  </select>

  <delete id="deleteByIds">
    DELETE FROM sync_op_dedup
    WHERE id IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </delete>

</mapper>
