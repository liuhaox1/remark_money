<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.remark.money.mapper.SyncRecordMapper">

  <resultMap id="SyncRecordResultMap" type="com.remark.money.entity.SyncRecord">
    <id property="id" column="id"/>
    <result property="userId" column="user_id"/>
    <result property="bookId" column="book_id"/>
    <result property="deviceId" column="device_id"/>
    <result property="lastSyncId" column="last_sync_id"/>
    <result property="lastSyncTime" column="last_sync_time"/>
    <result property="cloudBillCount" column="cloud_bill_count"/>
    <result property="syncDeviceId" column="sync_device_id"/>
    <result property="dataVersion" column="data_version"/>
    <result property="createdAt" column="created_at"/>
    <result property="updatedAt" column="updated_at"/>
  </resultMap>

  <select id="findByUserBookDevice" resultMap="SyncRecordResultMap">
    SELECT * FROM sync_record
    WHERE user_id = #{userId} AND book_id = #{bookId} AND device_id = #{deviceId}
  </select>

  <insert id="insert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO sync_record (user_id, book_id, device_id, last_sync_id, last_sync_time,
                            cloud_bill_count, sync_device_id, data_version, created_at, updated_at)
    VALUES (#{userId}, #{bookId}, #{deviceId}, #{lastSyncId}, #{lastSyncTime},
            #{cloudBillCount}, #{syncDeviceId}, #{dataVersion}, NOW(), NOW())
  </insert>

  <update id="update">
    UPDATE sync_record SET
      last_sync_id = #{lastSyncId},
      last_sync_time = #{lastSyncTime},
      cloud_bill_count = #{cloudBillCount},
      sync_device_id = #{syncDeviceId},
      data_version = #{dataVersion},
      updated_at = NOW()
    WHERE user_id = #{userId} AND book_id = #{bookId} AND device_id = #{deviceId}
  </update>

  <insert id="upsert">
    INSERT INTO sync_record (user_id, book_id, device_id, last_sync_id, last_sync_time,
                            cloud_bill_count, sync_device_id, data_version, created_at, updated_at)
    VALUES (#{userId}, #{bookId}, #{deviceId}, #{lastSyncId}, #{lastSyncTime},
            #{cloudBillCount}, #{syncDeviceId}, #{dataVersion}, NOW(), NOW())
    ON DUPLICATE KEY UPDATE
      last_sync_id = VALUES(last_sync_id),
      last_sync_time = VALUES(last_sync_time),
      cloud_bill_count = VALUES(cloud_bill_count),
      sync_device_id = VALUES(sync_device_id),
      data_version = VALUES(data_version),
      updated_at = NOW()
  </insert>

</mapper>

