<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.remark.money.mapper.TagInfoMapper">

  <resultMap id="TagInfoResultMap" type="com.remark.money.entity.TagInfo">
    <id property="id" column="id"/>
    <result property="userId" column="user_id"/>
    <result property="bookId" column="book_id"/>
    <result property="tagId" column="tag_id"/>
    <result property="name" column="name"/>
    <result property="color" column="color"/>
    <result property="sortOrder" column="sort_order"/>
    <result property="isDelete" column="is_delete"/>
    <result property="syncVersion" column="sync_version"/>
    <result property="updateTime" column="update_time"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <select id="findAllByUserIdAndBookId" resultMap="TagInfoResultMap">
    SELECT *
    FROM tag_info
    WHERE user_id = #{userId}
      AND book_id = #{bookId}
      AND is_delete = 0
    ORDER BY sort_order ASC, created_at ASC
  </select>

  <select id="findByUserIdBookIdAndTagIds" resultMap="TagInfoResultMap">
    SELECT *
    FROM tag_info
    WHERE user_id = #{userId}
      AND book_id = #{bookId}
      AND tag_id IN
      <foreach collection="tagIds" item="t" open="(" separator="," close=")">
        #{t}
      </foreach>
  </select>

  <insert id="insertOne" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO tag_info (user_id, book_id, tag_id, name, color, sort_order, is_delete, sync_version, update_time, created_at)
    VALUES (#{userId}, #{bookId}, #{tagId}, #{name}, #{color}, #{sortOrder}, #{isDelete}, 1, NOW(), NOW())
  </insert>

  <insert id="batchInsert">
    INSERT INTO tag_info (user_id, book_id, tag_id, name, color, sort_order, is_delete, sync_version, update_time, created_at)
    VALUES
    <foreach collection="items" item="t" separator=",">
      (#{t.userId}, #{t.bookId}, #{t.tagId}, #{t.name}, #{t.color}, #{t.sortOrder}, #{t.isDelete}, 1, NOW(), NOW())
    </foreach>
  </insert>

  <update id="updateWithExpectedSyncVersion">
    UPDATE tag_info
    SET name = #{tag.name},
        color = #{tag.color},
        sort_order = #{tag.sortOrder},
        is_delete = #{tag.isDelete},
        sync_version = sync_version + 1,
        update_time = NOW()
    WHERE id = #{tag.id}
      AND user_id = #{tag.userId}
      AND sync_version = #{expectedSyncVersion}
  </update>

  <update id="softDeleteByTagId">
    UPDATE tag_info
    SET is_delete = 1,
        sync_version = sync_version + 1,
        update_time = NOW()
    WHERE user_id = #{userId}
      AND book_id = #{bookId}
      AND tag_id = #{tagId}
  </update>

</mapper>
