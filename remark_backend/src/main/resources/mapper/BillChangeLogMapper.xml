<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.remark.money.mapper.BillChangeLogMapper">

  <resultMap id="BillChangeLogResultMap" type="com.remark.money.entity.BillChangeLog">
    <id property="changeId" column="change_id"/>
    <result property="bookId" column="book_id"/>
    <result property="scopeUserId" column="scope_user_id"/>
    <result property="actorUserId" column="actor_user_id"/>
    <result property="billId" column="bill_id"/>
    <result property="op" column="op"/>
    <result property="billVersion" column="bill_version"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <insert id="insert">
    INSERT INTO bill_change_log (book_id, scope_user_id, actor_user_id, bill_id, op, bill_version, created_at)
    VALUES (#{bookId}, #{scopeUserId}, #{actorUserId}, #{billId}, #{op}, #{billVersion}, NOW())
  </insert>

  <insert id="batchInsert">
    INSERT INTO bill_change_log (book_id, scope_user_id, actor_user_id, bill_id, op, bill_version, created_at)
    VALUES
    <foreach collection="list" item="item" separator=",">
      (#{item.bookId}, #{item.scopeUserId}, #{item.actorUserId}, #{item.billId}, #{item.op}, #{item.billVersion}, NOW())
    </foreach>
  </insert>

  <select id="countForScope" resultType="int">
    SELECT COUNT(*) FROM bill_change_log
    WHERE book_id = #{bookId} AND scope_user_id = #{scopeUserId}
  </select>

  <select id="existsAnyForScope" resultType="int">
    SELECT 1
    FROM bill_change_log
    WHERE book_id = #{bookId}
      AND scope_user_id = #{scopeUserId}
    LIMIT 1
  </select>

  <insert id="bootstrapShared">
    INSERT INTO bill_change_log (book_id, scope_user_id, actor_user_id, bill_id, op, bill_version, created_at)
    SELECT
      bi.book_id,
      #{scopeUserId},
      bi.user_id,
      bi.id,
      CASE WHEN bi.is_delete = 1 THEN 1 ELSE 0 END,
      bi.version,
      NOW()
    FROM bill_info bi
    WHERE bi.book_id = #{bookId}
      AND NOT EXISTS (
        SELECT 1 FROM bill_change_log bcl
        WHERE bcl.book_id = bi.book_id AND bcl.scope_user_id = #{scopeUserId} AND bcl.bill_id = bi.id
      )
  </insert>

  <insert id="bootstrapPersonal">
    INSERT INTO bill_change_log (book_id, scope_user_id, actor_user_id, bill_id, op, bill_version, created_at)
    SELECT
      bi.book_id,
      #{scopeUserId},
      bi.user_id,
      bi.id,
      CASE WHEN bi.is_delete = 1 THEN 1 ELSE 0 END,
      bi.version,
      NOW()
    FROM bill_info bi
    WHERE bi.user_id = #{userId} AND bi.book_id = #{bookId}
      AND NOT EXISTS (
        SELECT 1 FROM bill_change_log bcl
        WHERE bcl.book_id = bi.book_id AND bcl.scope_user_id = #{scopeUserId} AND bcl.bill_id = bi.id
      )
  </insert>

  <insert id="bootstrapTombstones">
    INSERT INTO bill_change_log (book_id, scope_user_id, actor_user_id, bill_id, op, bill_version, created_at)
    SELECT
      t.book_id,
      t.scope_user_id,
      0,
      t.bill_id,
      1,
      t.bill_version,
      NOW()
    FROM bill_delete_tombstone t
    WHERE t.book_id = #{bookId}
      AND t.scope_user_id = #{scopeUserId}
      AND NOT EXISTS (
        SELECT 1 FROM bill_change_log bcl
        WHERE bcl.book_id = t.book_id AND bcl.scope_user_id = t.scope_user_id AND bcl.bill_id = t.bill_id
      )
  </insert>

  <select id="findAfter" resultMap="BillChangeLogResultMap">
    SELECT change_id, book_id, scope_user_id, actor_user_id, bill_id, op, bill_version, created_at
    FROM bill_change_log
    WHERE book_id = #{bookId} AND scope_user_id = #{scopeUserId} AND change_id &gt; #{afterChangeId}
    ORDER BY change_id ASC
    LIMIT #{limit}
  </select>

  <select id="findRecent" resultMap="BillChangeLogResultMap">
    SELECT change_id, book_id, scope_user_id, actor_user_id, bill_id, op, bill_version, created_at
    FROM bill_change_log
    WHERE book_id = #{bookId}
      AND scope_user_id = #{scopeUserId}
      <if test="beforeChangeId != null">
        AND change_id &lt; #{beforeChangeId}
      </if>
    ORDER BY change_id DESC
    LIMIT #{limit}
  </select>

  <select id="findMaxChangeId" resultType="Long">
    SELECT MAX(change_id)
    FROM bill_change_log
    WHERE book_id = #{bookId}
      AND scope_user_id = #{scopeUserId}
  </select>

  <select id="findMinChangeIdSince" resultType="Long">
    SELECT MIN(change_id)
    FROM bill_change_log
    WHERE book_id = #{bookId}
      AND scope_user_id = #{scopeUserId}
      AND created_at &gt;= #{cutoff}
  </select>

  <select id="findRangeForScopeSince" resultType="com.remark.money.entity.BillChangeLogRange">
    SELECT
      (
        SELECT COALESCE(MAX(change_id), 0)
        FROM bill_change_log
        WHERE book_id = #{bookId} AND scope_user_id = #{scopeUserId}
      ) AS maxChangeId,
      (
        SELECT COALESCE(MIN(change_id), 0)
        FROM bill_change_log
        WHERE book_id = #{bookId} AND scope_user_id = #{scopeUserId} AND created_at &gt;= #{cutoff}
      ) AS minKeptChangeId
  </select>

  <delete id="deleteBefore">
    DELETE FROM bill_change_log WHERE created_at &lt; #{cutoff}
  </delete>

  <select id="findChangeIdsBefore" resultType="long">
    SELECT change_id
    FROM bill_change_log
    WHERE created_at &lt; #{cutoff}
    ORDER BY created_at ASC, change_id ASC
    LIMIT #{limit}
  </select>

  <delete id="deleteByChangeIds">
    DELETE FROM bill_change_log
    WHERE change_id IN
    <foreach collection="ids" item="id" open="(" separator="," close=")">
      #{id}
    </foreach>
  </delete>

</mapper>
