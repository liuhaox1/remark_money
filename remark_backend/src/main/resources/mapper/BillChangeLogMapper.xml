<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.remark.money.mapper.BillChangeLogMapper">

  <resultMap id="BillChangeLogResultMap" type="com.remark.money.entity.BillChangeLog">
    <id property="changeId" column="change_id"/>
    <result property="bookId" column="book_id"/>
    <result property="scopeUserId" column="scope_user_id"/>
    <result property="billId" column="bill_id"/>
    <result property="op" column="op"/>
    <result property="billVersion" column="bill_version"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <insert id="insert">
    INSERT INTO bill_change_log (book_id, scope_user_id, bill_id, op, bill_version, created_at)
    VALUES (#{bookId}, #{scopeUserId}, #{billId}, #{op}, #{billVersion}, NOW())
  </insert>

  <select id="countForScope" resultType="int">
    SELECT COUNT(*) FROM bill_change_log
    WHERE book_id = #{bookId} AND scope_user_id = #{scopeUserId}
  </select>

  <insert id="bootstrapShared">
    INSERT INTO bill_change_log (book_id, scope_user_id, bill_id, op, bill_version, created_at)
    SELECT
      bi.book_id,
      #{scopeUserId},
      bi.id,
      CASE WHEN bi.is_delete = 1 THEN 1 ELSE 0 END,
      bi.version,
      NOW()
    FROM bill_info bi
    WHERE bi.book_id = #{bookId} AND bi.include_in_stats = 1
      AND NOT EXISTS (
        SELECT 1 FROM bill_change_log bcl
        WHERE bcl.book_id = bi.book_id AND bcl.scope_user_id = #{scopeUserId} AND bcl.bill_id = bi.id
      )
  </insert>

  <insert id="bootstrapPersonal">
    INSERT INTO bill_change_log (book_id, scope_user_id, bill_id, op, bill_version, created_at)
    SELECT
      bi.book_id,
      #{scopeUserId},
      bi.id,
      CASE WHEN bi.is_delete = 1 THEN 1 ELSE 0 END,
      bi.version,
      NOW()
    FROM bill_info bi
    WHERE bi.user_id = #{userId} AND bi.book_id = #{bookId} AND bi.include_in_stats = 1
      AND NOT EXISTS (
        SELECT 1 FROM bill_change_log bcl
        WHERE bcl.book_id = bi.book_id AND bcl.scope_user_id = #{scopeUserId} AND bcl.bill_id = bi.id
      )
  </insert>

  <select id="findAfter" resultMap="BillChangeLogResultMap">
    SELECT change_id, book_id, scope_user_id, bill_id, op, bill_version, created_at
    FROM bill_change_log
    WHERE book_id = #{bookId} AND scope_user_id = #{scopeUserId} AND change_id &gt; #{afterChangeId}
    ORDER BY change_id ASC
    LIMIT #{limit}
  </select>

</mapper>
