<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.remark.money.mapper.IdSequenceMapper">

  <!--
    Ensure the sequence exists.
    Note: we only initialize once to avoid doing MAX(bill_info.id) on every allocation request.
  -->
  <insert id="ensureBillInfo">
    INSERT INTO id_sequence (name, next_id)
    SELECT 'bill_info', IFNULL((SELECT MAX(id) FROM bill_info), 0) + 1
    FROM DUAL
    WHERE NOT EXISTS (
      SELECT 1 FROM id_sequence WHERE name = 'bill_info'
    )
  </insert>

  <update id="advanceWithLastInsertId">
    UPDATE id_sequence
    SET next_id = LAST_INSERT_ID(next_id + #{count})
    WHERE name = #{name}
  </update>

  <update id="advance">
    UPDATE id_sequence SET next_id = next_id + #{count} WHERE name = #{name}
  </update>

  <select id="lastInsertId" resultType="long">
    SELECT LAST_INSERT_ID()
  </select>

</mapper>
