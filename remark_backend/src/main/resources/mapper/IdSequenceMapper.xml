<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.remark.money.mapper.IdSequenceMapper">

  <!--
    Ensure the sequence exists and is always >= MAX(bill_info.id)+1.
    This makes client-allocated ids safe even if bill_info already has data.
  -->
  <insert id="ensureBillInfo">
    INSERT INTO id_sequence (name, next_id)
    SELECT 'bill_info', IFNULL(MAX(id), 0) + 1 FROM bill_info
    ON DUPLICATE KEY UPDATE
      next_id = GREATEST(next_id, (SELECT IFNULL(MAX(id), 0) + 1 FROM bill_info))
  </insert>

  <select id="lockNextId" resultType="long">
    SELECT next_id FROM id_sequence WHERE name = #{name} FOR UPDATE
  </select>

  <update id="advance">
    UPDATE id_sequence SET next_id = next_id + #{count} WHERE name = #{name}
  </update>

</mapper>

