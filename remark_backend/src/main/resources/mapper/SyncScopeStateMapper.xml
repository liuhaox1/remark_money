<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.remark.money.mapper.SyncScopeStateMapper">

  <resultMap id="SyncScopeStateResultMap" type="com.remark.money.entity.SyncScopeState">
    <id property="id" column="id"/>
    <result property="bookId" column="book_id"/>
    <result property="scopeUserId" column="scope_user_id"/>
    <result property="initialized" column="initialized"/>
    <result property="createdAt" column="created_at"/>
    <result property="updatedAt" column="updated_at"/>
  </resultMap>

  <select id="find" resultMap="SyncScopeStateResultMap">
    SELECT id, book_id, scope_user_id, initialized, created_at, updated_at
    FROM sync_scope_state
    WHERE book_id = #{bookId} AND scope_user_id = #{scopeUserId}
    LIMIT 1
  </select>

  <!-- Create row if missing (portable SQL: insert-select-where-not-exists) -->
  <insert id="ensureExists">
    INSERT INTO sync_scope_state (book_id, scope_user_id, initialized, created_at, updated_at)
    SELECT #{bookId}, #{scopeUserId}, 0, NOW(), NOW()
    FROM (SELECT 1) t
    WHERE NOT EXISTS (
      SELECT 1 FROM sync_scope_state
      WHERE book_id = #{bookId} AND scope_user_id = #{scopeUserId}
    )
  </insert>

  <update id="markInitialized">
    UPDATE sync_scope_state
    SET initialized = 1, updated_at = NOW()
    WHERE book_id = #{bookId} AND scope_user_id = #{scopeUserId}
  </update>

  <update id="resetInitialized">
    UPDATE sync_scope_state
    SET initialized = 0, updated_at = NOW()
    WHERE book_id = #{bookId} AND scope_user_id = #{scopeUserId}
  </update>

</mapper>
