<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.remark.money.mapper.AccountInfoMapper">

  <resultMap id="AccountInfoResultMap" type="com.remark.money.entity.AccountInfo">
    <id property="id" column="id"/>
    <result property="userId" column="user_id"/>
    <result property="bookId" column="book_id"/>
    <result property="accountId" column="account_id"/>
    <result property="name" column="name"/>
    <result property="kind" column="kind"/>
    <result property="subtype" column="subtype"/>
    <result property="type" column="type"/>
    <result property="icon" column="icon"/>
    <result property="includeInTotal" column="include_in_total"/>
    <result property="includeInOverview" column="include_in_overview"/>
    <result property="currency" column="currency"/>
    <result property="sortOrder" column="sort_order"/>
    <result property="initialBalance" column="initial_balance"/>
    <result property="currentBalance" column="current_balance"/>
    <result property="counterparty" column="counterparty"/>
    <result property="interestRate" column="interest_rate"/>
    <result property="dueDate" column="due_date"/>
    <result property="note" column="note"/>
    <result property="brandKey" column="brand_key"/>
    <result property="isDelete" column="is_delete"/>
    <result property="syncVersion" column="sync_version"/>
    <result property="updateTime" column="update_time"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <select id="findById" resultMap="AccountInfoResultMap">
    SELECT * FROM account_info WHERE id = #{id}
  </select>

  <select id="findByIds" resultMap="AccountInfoResultMap">
    SELECT * FROM account_info WHERE id IN
    <foreach item="id" collection="ids" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select>

  <select id="findByUserIdAndIds" resultMap="AccountInfoResultMap">
    SELECT * FROM account_info WHERE user_id = #{userId} AND id IN
    <foreach item="id" collection="ids" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select>

  <select id="findByUserIdAndBookIdAndAccountId" resultMap="AccountInfoResultMap">
    SELECT * FROM account_info
    WHERE user_id = #{userId} AND book_id = #{bookId} AND account_id = #{accountId}
    LIMIT 1
  </select>

  <select id="findByUserIdAndBookIdAndAccountIds" resultMap="AccountInfoResultMap">
    SELECT * FROM account_info
    WHERE user_id = #{userId} AND book_id = #{bookId} AND account_id IN
    <foreach item="id" collection="accountIds" open="(" separator="," close=")">
      #{id}
    </foreach>
  </select>

  <select id="findAllByUserIdAndBookId" resultMap="AccountInfoResultMap">
    SELECT * FROM account_info
    WHERE user_id = #{userId} AND book_id = #{bookId} AND is_delete = 0
    ORDER BY sort_order ASC, id ASC
  </select>

  <select id="findAllByUserIdAndBookIdIncludingDeleted" resultMap="AccountInfoResultMap">
    SELECT * FROM account_info
    WHERE user_id = #{userId} AND book_id = #{bookId}
    ORDER BY sort_order ASC, id ASC
  </select>

  <delete id="deleteByUserIdAndBookIdAndAccountIdsNotIn">
    DELETE FROM account_info
    WHERE user_id = #{userId} AND book_id = #{bookId}
      AND account_id IS NOT NULL
      AND account_id NOT IN
      <foreach item="id" collection="accountIds" open="(" separator="," close=")">
        #{id}
      </foreach>
  </delete>

  <update id="softDeleteById">
    UPDATE account_info
    SET is_delete = 1, sync_version = sync_version + 1, update_time = NOW()
    WHERE user_id = #{userId} AND book_id = #{bookId} AND id = #{id}
  </update>

  <update id="softDeleteByAccountId">
    UPDATE account_info
    SET is_delete = 1, sync_version = sync_version + 1, update_time = NOW()
    WHERE user_id = #{userId} AND book_id = #{bookId} AND account_id = #{accountId}
  </update>

  <insert id="insert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO account_info (user_id, book_id, account_id, name, kind, subtype, type, icon,
                            include_in_total, include_in_overview, currency, sort_order,
                            initial_balance, current_balance, counterparty, interest_rate,
                            due_date, note, brand_key, is_delete, sync_version, update_time, created_at)
    VALUES (#{userId}, #{bookId}, #{accountId}, #{name}, #{kind}, #{subtype}, #{type}, #{icon},
            #{includeInTotal}, #{includeInOverview}, #{currency}, #{sortOrder},
            #{initialBalance}, #{currentBalance}, #{counterparty}, #{interestRate},
            #{dueDate}, #{note}, #{brandKey}, #{isDelete}, 1, NOW(), NOW())
  </insert>

  <insert id="batchInsert" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO account_info (user_id, book_id, account_id, name, kind, subtype, type, icon,
                            include_in_total, include_in_overview, currency, sort_order,
                            initial_balance, current_balance, counterparty, interest_rate,
                            due_date, note, brand_key, is_delete, sync_version, update_time, created_at)
    VALUES
    <foreach collection="list" item="item" separator=",">
      (#{item.userId}, #{item.bookId}, #{item.accountId}, #{item.name}, #{item.kind}, #{item.subtype}, #{item.type}, #{item.icon},
       #{item.includeInTotal}, #{item.includeInOverview}, #{item.currency}, #{item.sortOrder},
       #{item.initialBalance}, #{item.currentBalance}, #{item.counterparty}, #{item.interestRate},
       #{item.dueDate}, #{item.note}, #{item.brandKey}, #{item.isDelete}, 1, NOW(), NOW())
    </foreach>
  </insert>

  <update id="updateById">
    UPDATE account_info SET
      book_id = #{bookId},
      name = #{name},
      kind = #{kind},
      subtype = #{subtype},
      type = #{type},
      icon = #{icon},
      include_in_total = #{includeInTotal},
      include_in_overview = #{includeInOverview},
      currency = #{currency},
      sort_order = #{sortOrder},
      initial_balance = #{initialBalance},
      current_balance = #{currentBalance},
      counterparty = #{counterparty},
      interest_rate = #{interestRate},
      due_date = #{dueDate},
      note = #{note},
      brand_key = #{brandKey},
      is_delete = #{isDelete},
      sync_version = sync_version + 1,
      update_time = NOW()
    WHERE id = #{id} AND user_id = #{userId} AND book_id = #{bookId}
  </update>

  <update id="updateWithExpectedSyncVersion">
    UPDATE account_info SET
      book_id = #{account.bookId},
      name = #{account.name},
      kind = #{account.kind},
      subtype = #{account.subtype},
      type = #{account.type},
      icon = #{account.icon},
      include_in_total = #{account.includeInTotal},
      include_in_overview = #{account.includeInOverview},
      currency = #{account.currency},
      sort_order = #{account.sortOrder},
      initial_balance = #{account.initialBalance},
      current_balance = #{account.currentBalance},
      counterparty = #{account.counterparty},
      interest_rate = #{account.interestRate},
      due_date = #{account.dueDate},
      note = #{account.note},
      brand_key = #{account.brandKey},
      is_delete = #{account.isDelete},
      sync_version = sync_version + 1,
      update_time = NOW()
    WHERE id = #{account.id}
      AND user_id = #{account.userId}
      AND book_id = #{account.bookId}
      AND sync_version = #{expectedSyncVersion}
  </update>

  <update id="batchUpdate">
    <bind name="userId" value="list[0].userId"/>
    <bind name="bookId" value="list[0].bookId"/>
    UPDATE account_info
    SET
      book_id = #{bookId},
      name = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.name}
        </foreach>
        ELSE name
      END,
      kind = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.kind}
        </foreach>
        ELSE kind
      END,
      subtype = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.subtype}
        </foreach>
        ELSE subtype
      END,
      type = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.type}
        </foreach>
        ELSE type
      END,
      icon = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.icon}
        </foreach>
        ELSE icon
      END,
      include_in_total = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.includeInTotal}
        </foreach>
        ELSE include_in_total
      END,
      include_in_overview = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.includeInOverview}
        </foreach>
        ELSE include_in_overview
      END,
      currency = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.currency}
        </foreach>
        ELSE currency
      END,
      sort_order = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.sortOrder}
        </foreach>
        ELSE sort_order
      END,
      initial_balance = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.initialBalance}
        </foreach>
        ELSE initial_balance
      END,
      current_balance = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.currentBalance}
        </foreach>
        ELSE current_balance
      END,
      counterparty = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.counterparty}
        </foreach>
        ELSE counterparty
      END,
      interest_rate = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.interestRate}
        </foreach>
        ELSE interest_rate
      END,
      due_date = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.dueDate}
        </foreach>
        ELSE due_date
      END,
      note = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.note}
        </foreach>
        ELSE note
      END,
      brand_key = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.brandKey}
        </foreach>
        ELSE brand_key
      END,
      is_delete = CASE id
        <foreach collection="list" item="item">
          WHEN #{item.id} THEN #{item.isDelete}
        </foreach>
        ELSE is_delete
      END,
      sync_version = sync_version + 1,
      update_time = NOW()
    WHERE user_id = #{userId}
      AND book_id = #{bookId}
      AND id IN
      <foreach item="item" collection="list" open="(" separator="," close=")">
        #{item.id}
      </foreach>
  </update>

</mapper>
