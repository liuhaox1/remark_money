<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.remark.money.mapper.SavingsPlanInfoMapper">

  <resultMap id="SavingsPlanInfoResultMap" type="com.remark.money.entity.SavingsPlanInfo">
    <id property="id" column="id"/>
    <result property="userId" column="user_id"/>
    <result property="bookId" column="book_id"/>
    <result property="planId" column="plan_id"/>
    <result property="payloadJson" column="payload_json"/>
    <result property="isDelete" column="is_delete"/>
    <result property="syncVersion" column="sync_version"/>
    <result property="updateTime" column="update_time"/>
    <result property="createdAt" column="created_at"/>
  </resultMap>

  <select id="findByUserIdBookIdAndPlanId" resultMap="SavingsPlanInfoResultMap">
    SELECT *
    FROM savings_plan_info
    WHERE user_id = #{userId}
      AND book_id = #{bookId}
      AND plan_id = #{planId}
    LIMIT 1
  </select>

  <select id="findByUserIdBookIdAndPlanIds" resultMap="SavingsPlanInfoResultMap">
    SELECT *
    FROM savings_plan_info
    WHERE user_id = #{userId}
      AND book_id = #{bookId}
      AND plan_id IN
      <foreach collection="planIds" item="planId" open="(" separator="," close=")">
        #{planId}
      </foreach>
  </select>

  <select id="findAllByUserIdAndBookId" resultMap="SavingsPlanInfoResultMap">
    SELECT *
    FROM savings_plan_info
    WHERE user_id = #{userId}
      AND book_id = #{bookId}
    ORDER BY update_time DESC, id DESC
  </select>

  <insert id="insertOne" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO savings_plan_info (
      user_id,
      book_id,
      plan_id,
      payload_json,
      is_delete,
      sync_version,
      update_time,
      created_at
    ) VALUES (
      #{userId},
      #{bookId},
      #{planId},
      #{payloadJson},
      #{isDelete},
      1,
      NOW(),
      NOW()
    )
  </insert>

  <update id="updateWithExpectedSyncVersion">
    UPDATE savings_plan_info
    SET
      payload_json = #{plan.payloadJson},
      is_delete = #{plan.isDelete},
      sync_version = sync_version + 1,
      update_time = NOW()
    WHERE user_id = #{plan.userId}
      AND book_id = #{plan.bookId}
      AND plan_id = #{plan.planId}
      AND sync_version = #{expectedSyncVersion}
  </update>

  <update id="softDeleteByPlanId">
    UPDATE savings_plan_info
    SET
      is_delete = 1,
      sync_version = sync_version + 1,
      update_time = NOW()
    WHERE user_id = #{userId}
      AND book_id = #{bookId}
      AND plan_id = #{planId}
  </update>

</mapper>
